] put in a loop here to load in blocks so we don't have to load 255
] blocks at startup
i ju main

: ok
i @pju pword
c ok\n

: pword
i aapu@pa!
d 0
: pwloop
i ifduot@ppu
r pwend
d 7
i 2/unju pwloop
: pwend
i drpoa!;;

: pstring
i aapua!@+pu
: pstringloop
i @+ca pword
i nxpoa!;;
r pstringloop

: radix
d -10

: swap
i ovpuovororpo
i ;;

: rswap
i popopoovpuov
i ororpupu;;

: /mod
i ca ./modin
i ovoror
i du@panpu@ppu
x ffff
d 15
i 2/un@panpo;;
x ffff

: ./modin
i @p@ppupu
d 14
d 15
i 2*un
i ovpuovor
i orpo
: ./modlp
i ovov++-idr2*
r ./modthen
i nx;;
r ./modlp
: ./modthen
i ovoror--2*--
i nx;;
r ./modlp

: 256*
i 2*2*2*
: 32*
i 2*2*2*2*2*;;

: 256/
i 2/2/2/
: 32/
i 2/2/2/2/2/;;

: dec
i @p++;;
d -1

: inc
i @p++;;
d 1

d 0
d 0
d 0
: numpad
d 0

: itoa
i @ppu
r numpad
: itoaloop
i duduorpu
i ca itoa+
i ifca itoa+
r itoa;;
i ifca itoa+
r itoa;;
i ifca itoa+
r itoa;;
i ifpopodupua!
r itoa;;
i !!nx
r itoaloop
: itoa;;
i drpopodupua!
i !!poca dec
i dupu
i --@p++podupu
r numpad
i a!!!po
i ;;

: itoa+
i ca rswap
i @pa!@@ca /mod
r radix
i ovpuovororpo
i ca numchar
i poca 256*
i ++puca rswap
i ;;

: numchar
i @p++du@p++
d 48
d -58
i -idr;;
r numchar;;
: numchar;;
i dr@p++;;
d 39

: nl
i @p@pa!ot;;
c \n
d 0

: echo
i @ppu@pa!
d 10
d 0
i inotun;;

: dbg
i aapu@pa!indr
d 3
i poa!;;

: peek
i duca itoa
i ju pstring

d 0
: wpad
d 0
d 0
d 0
d 0
d 0

: EOL
d 0

: ok?
i @pa!@@--ifdr
r EOL
r .ok?
i ;;
: .ok?
i drca ok
i @p!!;;
d 0

: white
i indu@p++-i
d -33
r .white
i drdu@porif
d 10
r .white
i drdrju white
: .white
i dr;;

: wrotate
i duduorpu
: .wrotateloop
i du@panpoca 256*
x ff
i ++puca 256/
i ifju .wrotateloop
r .wrotate;;
: .wrotate;;
i drpo;;

: word+
i ca 256*
i indupu++po;;

: wtest
i du@porifdr@p
d 10
r .nltest
d -33
i ++--;;
: .nltest
i @pa!@p!!dr@p
r EOL
d -1
d -33
i ++--;;

: word
i @p--pu@pa!
r wpad
d 0
i ca white
i ju .wordloop2
: .wordloop1
i @pdua!
d 0
i ca word+
i ca wtest
i -idr
r .word-;;
: .wordloop2
i ca word+
i ca wtest
i -idrca word+
r .word;;
i ca wtest
i -idrca word+
r .word;;
i ca wtest
i -idrca wrotate
r .word;;
i podupu--a!!!
i nx
r .wordloop1
: .word;;
i drca 256/
i ca wrotate
i podupu--a!!!
i @pdupo++--pu
r wpad
i @p++dua!po!!
d -1
i ;;
: .word-;;
i drdrpo--@pdu
r wpad
i pu--++po@p++
d -1
i a!!!aa
i ju dbg
i ;;

: atoi+
i ca rswap
i du@pan@p++du
x ff
d -48
i @p++---idr@p
d -10
r .atoi+
d -39
i ++ju .atoi+;;
: .atoi+
i dr
: .atoi+;;
i poaa@pa!@@--
r radix
i @p++pua!po**
d 1
i ++puca rswap
i ju 256/

: atoi
i a!@+pu@p
d 0
: .atoiloop
i pu@+
i ca atoi+
i ifca atoi+
r .atoi;;
i ifca atoi+
r .atoi;;
i ifca atoi+
r .atoi;;
i ifponxju .atoi;;nx
r .atoi;;
r .atoiloop
: .atoi;;
i drpopodr;;
: .atoi;;nx
i drpo;;

: logic
i ifduor--;;
r .logic
: .logic
i ;;

: main
i ca word
i ca ok?
i @pca find
d 0
i ca itoa
i ca pstring
i xx

: eqstr
d 1
c hell
c o

: tstring
d 3
c hell
c o\swo
c rld!
c \n

: forths

+ 138
: forth
d 0
c -:
r colon
d 0
c pstr
r pstring
d 0
c word
r word
d 0
c atoi
r atoi
d 0
c itoa
r itoa
d 0
c o,
r compop
d 0
c ,
r comma
d 0
c -]
r comp
d 1
c fort
c h
r forthctxt
d 1
c macr
c o
r macroctxt
d 0
c find
r find
: fthend

: macros

+ 161
: macro
d 0
c [
r interp
d 0
c -;
r cret
d 0
c ,m
r postpone
: mcrend

: here
r end

: dict
r forths
r macros
r fthend
r mcrend
r forth
r macro

: slot
d 0

: !ctxt
i @pdr!p;;
: ctxt
i @p;;
d 0

] (s1 s2 -- s1 s2+l b)
: streq
i ovca b!
i dua!@@@p++du
d 1
i pu@p++++
d 1

: .streqlp
i @+ca @b+
i orifdr
r .streq
i poduor;;
: .streq
i drnx
r .streqlp
i duduor--;;


] find: turn dictionary offset into string, compare string, if equal,
] get value, if not, add 1 and repeat.

: find
i dupu@p@p++++
r dict
d 4
i a!@@

: .findlp
i ca streq
i ifpodrdr
r .find
i a!@@;;
: .find
i dra!@+draa
i ca dbg
i du@p@ppodupu
r dict
d 2
i ++++a!@@--++
i -idrju .findlp
r .find;;
: .find;;
i podrdrduor;;


: b!
i @pdr!p;;
: b
i @p;;
d 0

: @b+
i aapuca b
i a!@+aaca b!
i poa!;;

: !b+
i aapuca b
i a!!+aaca b!
i poa!;;

: strcpy
i ca b!
i a!@+duca !b+
i pu
: .strcpy
i @+ca !b+
i nx;;
r .strcpy

: colon
i ca word
i dupuca strcpy
i ca b
i ca ctxt
i a!!!
i @pa!!+
i ca comma
i poca ctxt
i @p++a!!!;;
d 1

: !opbuf
i @pdr!p;;
: opbuf
i @p;;
d 0

: opbuf+
i ca opbuf
i ++ju !opbuf

: !opcnt
i @pdr!p;;
: opcnt
i @p;;
d 0

: opcnt+
i ca opcnt
i @p++@porif
d 1
d 5
r commit
] implement commit
i ju !opcnt

: flushcomp
i ca opbuf
i ifdupuca comma
r .flushcomp;;
i poduordu
i ca !opcnt
i ju !opbuf
: .flushcomp;;
i dr;;

: compop
i ca opcnt
i ifpu
: .compoplp
r .compop
i 2*2*2*2*2*po
i @p++ju .compoplp
d -1
: .compop
i ca opbuf+
i ju opcnt+

: comma
i @pa!@@dupua!
r ctxt
i @@a!!+aapoa!
i !!;;

: execute
i pu;;

: compword
i ca flushcomp
i @pca compop
x 3
i ca compop
i ju flushcomp

: comp
i podrca word
i @pca find
r macros
i ifpudrpo
r .comp
i ca execute
i ju comp
: .comp
i dr@pca find
r forths
i ifpudrpo
i ca compword
r .comp-abort
i ju comp
: .comp-abort
i drdr@pca pword
c wrd?
i ju comp

: forthctxt
i @pju !ctxt
r forths

: macroctxt
i @pju !ctxt
r macros

: interp
i podrca word
i ca ok?
i @pca find
r forths
i ifpudrpo
r .interp-abort
i ca execute
i ju interp
: .interp-abort
i drdr@pca pword
c wrd?
i ju interp

: cret
i @pju compop
x 1c

: postpone
i ca word
i @pca find
r macros
i pudrpo
i ifju compword
r .postpone
: .postpone
i @pju pword
c wrd?

: end
